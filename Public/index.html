<!doctype html>
<html lang="en">
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" charset="utf-8">
  <title>Inventory Scanning</title>

  <!-- Chart.js (LOCAL) -->
  <script src="js/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>

  <style>
    /* Base and Background */
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background: linear-gradient(rgba(255,255,255,0.85), rgba(255,255,255,0.85)),
                  url('Media/RockvilleFront.jpg') no-repeat center center fixed;
      background-size: 75% auto;
      background-position: right;
      background-attachment: fixed;
      color: #333;
    }
    /* Left Navigation Pane */
    .left-nav {
      position: fixed;
      top: 0;
      left: 0;
      width: 200px;
      height: 100%;
      background: rgba(146,208,80,0.95);
      box-shadow: 2px 0 4px rgba(0,0,0,0.1);
      z-index: 1000;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding-top: 20px;
    }
    .nav-header {
      margin-bottom: 20px;
      text-align: center;
    }
    .nav-header img {
      max-width: 80%;
      height: auto;
    }
    .left-nav ul {
      list-style: none;
      padding: 0;
      margin: 0;
      width: 100%;
    }
    .left-nav li {
      margin: 10px 0;
      text-align: center;
    }
    .left-nav li a {
      color: #fff;
      text-decoration: none;
      font-size: 18px;
      display: block;
      padding: 10px 0;
      transition: background 0.3s;
    }
    .left-nav li a:hover {
      background: rgba(37,64,143,1);
    }
    /* Top Bar */
    .top-bar {
      position: fixed;
      top: 0;
      left: 200px;
      width: calc(100% - 200px);
      height: 110px;
      background: rgba(146,208,80,0.95);
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 20px;
      z-index: 1000;
      border-radius: 0;
    }
    .top-bar h1 {
      color: rgba(37,64,143,1);
      font-size: 36px;
      margin: 0 auto;
      text-align: center;
      flex-grow: 1;
    }
    .top-bar img {
      max-height: 80px;
      width: auto;
    }
    /* Main Content */
    .content {
      margin: 120px 120px 20px 220px;
      padding: 20px;
    }
    /* Controls */
    .controls, .statsBox, .search-controls {
      background: rgba(255,255,255,0.9);
      border: 1px solid rgba(200,200,200,0.7);
      border-radius: 4px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      padding: 10px;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
    }
    #mainControls {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
    }
    #leftControls, #rightControls {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    #statusContainer {
      text-align: center;
      flex-grow: 1;
    }
    .controls button {
      font-size: 20px;
      padding: 12px 24px;
      border: none;
      background-color: rgba(37,64,143,1);
      color: #fff;
      border-radius: 4px;
      cursor: pointer;
      transition: transform 0.3s ease, background-color 0.3s ease;
    }
    .controls button:hover {
      background-color: rgba(37,64,143,0.9);
      transform: translateY(-2px);
    }
    .status-bar {
      font-size: 26px;
      font-weight: bold;
      min-height: 30px;
    }
    #timer {
      font-size: 26px;
      font-weight: bold;
    }
    /* Reader Connection Status */
    #connectionStatus {
      display: flex;
      gap: 20px;
      justify-content: center;
      margin-top: 5px;
      font-size: 18px;
    }
    .statusIcon {
      font-size: 28px;
      text-shadow: 0 0 5px rgba(0,0,0,0.3);
    }
    /* Search Controls */
    .search-controls label {
      font-size: 18px;
      font-weight: bold;
    }
    .search-controls input {
      width: 200px;
      font-size: 16px;
      padding: 8px;
    }
    .search-controls button {
      font-size: 16px;
      padding: 8px 16px;
    }
    /* Table */
    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 20px;
      background: #fff;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    table th, table td {
      padding: 12px 15px;
      font-size: 18px;
      text-align: left;
      border-bottom: 1px solid #ddd;
      vertical-align: top;
      white-space: nowrap;
    }
    table th {
      background-color: #f2f2f2;
      border-bottom: 2px solid #ddd;
      cursor: pointer;
      user-select: none;
      position: sticky;
      top: 110px;
      z-index: 2;
    }
    table tr:nth-child(even) { background-color: #f9f9f9; }
    table tr:hover { background-color: #e9e9e9; }

    /* Pagination */
    #paginationControls {
      margin-top: 10px;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      align-items: center;
      gap: 5px;
    }
    #paginationControls button {
      padding: 6px 12px;
      font-size: 16px;
    }

    /* Stats Layout */
    #statsContainer {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
      margin-bottom: 20px;
      align-items: stretch;
    }
    #leftStats {
      display: flex;
      flex-direction: column;
      gap: 20px;
      flex: 1;
      min-width: 280px;
    }
    .statsBox {
      background: rgba(255,255,255,0.9);
      border: 1px solid rgba(200,200,200,0.7);
      border-radius: 4px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      padding: 10px;
    }
    .statsBox h3 {
      margin-top: 0;
      margin-bottom: 10px;
      text-align: center;
    }
    .statsBox table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 0;
      box-shadow: none;
    }
    .statsBox table td {
      padding: 5px 10px;
      border-bottom: none;
      font-size: 16px;
    }
    #readerHealthCard table {
      width: 100%;
      border-collapse: collapse;
    }
    #readerHealthCard th, #readerHealthCard td {
      padding: 6px 8px;
      text-align: left;
      font-size: 15px;
      border-bottom: 1px solid #eee;
    }
    #readerHealthCard th {
      background: #f7f7f7;
      position: sticky;
      top: 0;
      z-index: 1;
    }

    #chartsColumn {
      flex: 1;
      min-width: 320px;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    .chartBox {
      background: rgba(255,255,255,0.9);
      border: 1px solid rgba(200,200,200,0.7);
      border-radius: 4px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      padding: 10px;
      text-align: center;
    }
    .chartBox h3 { margin: 0 0 10px 0; }
    .chartCanvas {
      width: 360px !important;
      height: 360px !important;
    }

    #tagsTable tbody tr { cursor: pointer; }
    .tableWrap { overflow-x: auto; }
    .truncate {
      max-width: 220px;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Popups/Modals */
    #recordOptionsPopup {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #fff;
      border: 1px solid #ccc;
      padding: 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      z-index: 2000;
      display: none;
      width: 360px;
      text-align: center;
    }
    #recordOptionsPopup button {
      font-size: 16px;
      padding: 8px 12px;
      margin: 5px;
    }
    #recordOptionsPopup .closePopup {
      position: absolute;
      top: 5px;
      right: 10px;
      cursor: pointer;
      font-size: 20px;
    }
    #findBoxModal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
    }
    #findBoxModalContent {
      background: #fff;
      padding: 30px;
      border-radius: 8px;
      text-align: center;
      width: 400px;
      position: relative;
      box-shadow: 0 6px 18px rgba(0,0,0,0.3);
    }
    #findBoxModalContent input {
      font-size: 18px;
      padding: 10px;
      width: 80%;
      margin-bottom: 15px;
    }
    #signalIndicator {
      width: 70px;
      height: 70px;
      background-color: rgba(37,64,143,0.5);
      border-radius: 50%;
      margin: 20px auto;
      transition: transform 0.5s, background-color 0.5s;
    }
    .closeModal {
      position: absolute;
      top: 10px;
      right: 15px;
      cursor: pointer;
      font-size: 24px;
    }
  </style>
</head>
<body>
  <div class="left-nav">
    <div class="nav-header">
      <img src="Media/companylogo.png" alt="Company Logo">
    </div>
    <ul>
      <li><a href="index.html" class="navLink">Scanning</a></li>
      <li><a href="findBox.html" class="navLink">Find a Box</a></li>
      <li><a href="sharepoint.html" class="navLink">Scan Data</a></li>
      <li><a href="liveScan.html" class="navLink">Live Data Scan</a></li>
      <li><a href="dbPreview.html" class="navLink">DB Preview</a></li>
    </ul>
  </div>

  <div class="top-bar">
    <h1>Inventory Scanning&nbsp; &nbsp; &nbsp;&nbsp;</h1>
    <img src="Media/grouplogo.png" alt="Group Logo">
  </div>

  <div class="content">
    <div class="controls" id="mainControls">
      <div id="leftControls">
        <button id="startBtn">Start</button>
        <button id="pauseBtn">Pause</button>
        <button id="stopBtn">Stop</button>
      </div>
      <div id="statusContainer">
        <span id="timer">00:00:00</span><br>
        <span id="scanningStatus">üî¥ Not Scanning</span>
        <div id="connectionStatus">
          <span id="reader1Status">Reader8Port: <span class="statusIcon" style="color:green;">‚óè</span></span>
          <span id="reader2Status">Reader4Port: <span class="statusIcon" style="color:green;">‚óè</span></span>
        </div>
      </div>
      <div id="rightControls">
        <button id="clearBtn">Clear Data</button>
        <button id="exportBtn">Export XLSX</button>
        <button id="exportFilteredBtn">Export Filtered</button>
      </div>
    </div>

    <div class="status-bar" id="statusMessage"></div>

    <div class="statsBox" id="readerHealthCard">
      <h3>Reader Health</h3>
      <table>
        <thead>
          <tr>
            <th>Reader</th>
            <th>Status</th>
            <th>Last OK (s ago)</th>
            <th>Last Tag (s ago)</th>
            <th>Error</th>
          </tr>
        </thead>
        <tbody id="readerHealthBody">
          <tr><td colspan="5">Loading‚Ä¶</td></tr>
        </tbody>
      </table>
    </div>

    <div id="statsContainer">
      <div id="leftStats">
        <div class="statsBox" id="lotTypeStats">
          <h3>ASCII Lot Types</h3>
          <table>
            <tr><td>PL:</td><td id="plCount">0 (0%)</td></tr>
            <tr><td>FF:</td><td id="ffCount">0 (0%)</td></tr>
            <tr><td>BL:</td><td id="blCount">0 (0%)</td></tr>
            <tr><td>GL:</td><td id="glCount">0 (0%)</td></tr>
            <tr><td>Other:</td><td id="otherCount">0 (0%)</td></tr>
            <tr><td><b>Total:</b></td><td id="lotTypeTotal"><b>0</b></td></tr>
          </table>
        </div>

        <div class="statsBox" id="asciiLengthStats">
          <h3>ASCII Lengths</h3>
          <table>
            <tr><td>8 chars:</td><td id="len8Count">0 (0%)</td></tr>
            <tr><td>12 chars:</td><td id="len12Count">0 (0%)</td></tr>
            <tr><td>16 chars:</td><td id="len16Count">0 (0%)</td></tr>
            <tr><td>Other Length:</td><td id="lenOtherCount">0 (0%)</td></tr>
            <tr><td><b>Total:</b></td><td id="lenTotal"><b>0</b></td></tr>
          </table>
        </div>

        <div class="statsBox" id="totalsBox">
          <h3>Totals</h3>
          <table>
            <tr><td>Total Pounds:</td><td id="totalPounds">0</td></tr>
            <tr><td>Total Value (Pounds √ó Price):</td><td id="totalValue">$0.00</td></tr>
            <tr><td>DB Match Rate:</td><td id="dbMatchRate">0 / 0 (0%)</td></tr>
          </table>
        </div>

        <div class="statsBox" id="completenessBox">
          <h3>Data Completeness</h3>
          <table>
            <tr><td>Records with Pounds:</td><td id="hasPounds">0</td></tr>
            <tr><td>Records missing Pounds:</td><td id="noPounds">0</td></tr>
            <tr><td>Records with Price:</td><td id="hasPrice">0</td></tr>
            <tr><td>Records missing Price:</td><td id="noPrice">0</td></tr>
          </table>
        </div>

        <div class="statsBox" id="timeWindowBox">
          <h3>Time Window</h3>
          <table>
            <tr><td>Tags seen (last 10 seconds):</td><td id="tagsLast10Unique">0</td></tr>
            <tr><td>Tags seen (last 60s):</td><td id="tagsLast60">0</td></tr>
            <tr><td>New tags / minute:</td><td id="newPerMin">0</td></tr>
            <tr><td>Time since last new tag:</td><td id="sinceLastNew">‚Äî</td></tr>
          </table>
        </div>

        <div class="statsBox" id="readerCountsBox">
          <h3>Reader Stats</h3>
          <table>
            <thead>
              <tr><th>Reader</th><th>Unique Tags</th><th>Tags/min (last 60s)</th></tr>
            </thead>
            <tbody id="readerCountsBody">
              <tr><td colspan="3">No data</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <div id="chartsColumn">
        <div class="chartBox" id="chartContainer">
          <h3>Lot Type Pie Chart</h3>
          <canvas id="lotTypeChart" class="chartCanvas" width="360" height="360"></canvas>
        </div>

        <div class="chartBox">
          <h3>Type Pie Chart</h3>
          <canvas id="typeChart" class="chartCanvas" width="360" height="360"></canvas>
        </div>

        <div class="chartBox">
          <h3>Color Pie Chart</h3>
          <canvas id="colorChart" class="chartCanvas" width="360" height="360"></canvas>
        </div>
      </div>
    </div>

    <div class="controls search-controls">
      <label for="searchInput">Search ASCII:</label>
      <input id="searchInput" type="text" placeholder="e.g. PL002314" />
      <button id="searchBtn">Search</button>
      <button id="clearSearchBtn">Clear Search</button>
    </div>

    <h2>Tag List (Filtered): <span id="count">0</span></h2>

    <div class="tableWrap">
      <table id="tagsTable">
        <thead>
          <tr>
            <th onclick="sortTags('firstSeen')">First Seen</th>
            <th>TID (Hex)</th>
            <th>EPC (Hex)</th>
            <th onclick="sortTags('epcAscii')">ASCII</th>
            <th>RSSI</th>
            <th>SeenCount</th>
            <th>LOT</th>
            <th>DEPT</th>
            <th>ROW</th>
            <th>DEPT LOT</th>
            <th>SUPPLIER</th>
            <th>TYPE</th>
            <th>COLOR</th>
            <th>FORMAT</th>
            <th>POUNDS</th>
            <th>PRICE</th>
            <th>FREIGHT</th>
            <th>TOLL</th>
            <th>DATE</th>
          </tr>
        </thead>
        <tbody id="tagsBody"></tbody>
      </table>
    </div>

    <div id="paginationControls"></div>
  </div>

  <div id="recordOptionsPopup">
    <span class="closePopup" id="closePopup">&times;</span>
    <p id="popupMessage">Options for record: <span id="popupRecord"></span></p>
    <button id="popupFindBoxBtn">Find Box</button>
    <button id="popupPullSPBtn">Pull DB Data</button>
    <button id="popupCopyAsciiBtn">Copy ASCII</button>
    <div id="sharepointData" style="margin-top:10px; display:none;"></div>
  </div>

  <div id="findBoxModal">
    <div id="findBoxModalContent">
      <span class="closeModal" id="closeFindBox">&times;</span>
      <h3>Find a Box</h3>
      <input type="text" id="findBoxInput" placeholder="Enter ASCII text" />
      <br>
      <button id="searchBoxBtn">Search Box</button>
      <button id="querySharepointBtn">Query Sharepoint</button>
      <div id="signalIndicator"></div>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>

  <script>
    let allTags = [];
    let readerHealthState = [];
    let timerInterval = null;
    let startTime = null;
    let elapsedTime = 0;
    let isScanning = false;
    let currentSort = 'firstSeen';

    let lotChart = null;
    let typeChart = null;
    let colorChart = null;

    Chart.register(ChartDataLabels);

    let currentPage = 1;
    const pageSize = 500;

    let dbMap = new Map(); // key: ASCII (RFIDBOX)
    let lastFiltered = [];
    let lotTypeFilter = null;

    // Time-window tracking
    let lastNewTagAt = 0; // ms epoch; only updates when we see a NEW tag (not just seenCount updates)

    // Stats throttle
    let lastStatsAt = 0;
    const STATS_MIN_INTERVAL_MS = 500;

    let pendingRerender = false;
    function scheduleRerender() {
      if (pendingRerender) return;
      pendingRerender = true;
      requestAnimationFrame(() => {
        applyFilter();
        pendingRerender = false;
      });
    }

    const socket = io();
    let pollTimer = null;
    function startPolling(intervalMs = 60000) {
      clearInterval(pollTimer);
      pollTimer = setInterval(refreshTags, intervalMs);
    }
    socket.on('connect', () => { startPolling(60000); fetchReaderHealth(); });
    socket.on('disconnect', () => startPolling(3000));
    socket.on('readerHealth', data => {
      readerHealthState = Array.isArray(data) ? data : [];
      renderReaderHealth();
    });

    socket.on('newTag', tag => {
      const ex = allTags.find(t => t.epcHex === tag.epcHex);
      if (ex) {
        ex.seenCount = tag.seenCount;
        ex.rssi = tag.rssi;
        const readerLabel = getReaderLabel(tag);
        if (readerLabel) {
          ex.reader = ex.reader || readerLabel;
          ex.readerIp = ex.readerIp || tag.readerIp;
          ex._readerKey = readerLabel;
        }
      } else {
        tag._ascii = (tag.epcAscii || "").toLowerCase();
        tag._ts = Date.parse(tag.firstSeen || 0) || 0;
        tag._readerKey = getReaderLabel(tag);
        allTags.push(tag);
        lastNewTagAt = Date.now();
      }
      scheduleRerender();
    });

    socket.on('clearData', function() {
      allTags = [];
      lastNewTagAt = 0;
      renderTags([]);
      resetTimerDisplay();
      updateStats(true);
    });

    function fetchReaderHealth() {
      fetch('/api/health', { cache: 'no-store' })
        .then(safeJson)
        .then(data => {
          readerHealthState = Array.isArray(data) ? data : [];
          renderReaderHealth();
        })
        .catch(err => console.warn("Health fetch failed:", err));
    }

    function formatSecondsAgo(ts, now = Date.now()) {
      const ms = normalizeTimestampMs(ts);
      if (!ms) return "‚Äî";
      const diffSec = Math.max(0, Math.floor((now - ms) / 1000));
      return diffSec.toLocaleString();
    }

    function truncateError(str, maxLen = 80) {
      const s = String(str || "");
      return s.length > maxLen ? (s.slice(0, maxLen - 1) + "‚Ä¶") : s;
    }

    function renderReaderHealth() {
      const tbody = document.getElementById('readerHealthBody');
      if (!tbody) return;
      tbody.innerHTML = "";

      if (!readerHealthState || !readerHealthState.length) {
        const tr = document.createElement('tr');
        const td = document.createElement('td');
        td.colSpan = 5;
        td.textContent = "No reader data";
        tr.appendChild(td);
        tbody.appendChild(tr);
        return;
      }

      const now = Date.now();
      readerHealthState.forEach(h => {
        const tr = document.createElement('tr');
        const status = h.reachable ? (h.authOk ? "Online" : "AuthFail") : "Offline";
        const cols = [
          h.name || h.ip || "Unknown",
          status,
          formatSecondsAgo(h.lastOkAt, now),
          formatSecondsAgo(h.lastTagAt, now),
          truncateError(h.lastError || "", 60)
        ];
        cols.forEach((txt, idx) => {
          const td = document.createElement('td');
          td.textContent = txt;
          if (idx === 4) td.classList.add('truncate');
          tr.appendChild(td);
        });
        tbody.appendChild(tr);
      });
    }

    document.addEventListener('DOMContentLoaded', () => init());

    function init() {
      restoreStateFromUrl();
      loadDbMap().finally(() => refreshTags());

      document.getElementById('startBtn').addEventListener('click', startScan);
      document.getElementById('pauseBtn').addEventListener('click', pauseScan);
      document.getElementById('stopBtn').addEventListener('click', stopScan);
      document.getElementById('clearBtn').addEventListener('click', clearData);
      document.getElementById('exportBtn').addEventListener('click', exportData);
      document.getElementById('exportFilteredBtn').addEventListener('click', exportFiltered);

      document.getElementById('searchBtn').addEventListener('click', () => { currentPage = 1; applyFilter(); });
      document.getElementById('clearSearchBtn').addEventListener('click', () => {
        document.getElementById('searchInput').value = "";
        currentPage = 1;
        applyFilter();
      });
      document.getElementById('searchInput').addEventListener('keydown', (e) => {
        if (e.key === 'Enter') { currentPage = 1; applyFilter(); }
      });

      document.getElementById('closeFindBox').addEventListener('click', closeFindBoxModal);
      document.getElementById('searchBoxBtn').addEventListener('click', findBox);

      document.getElementById('closePopup').addEventListener('click', closeRecordOptionsPopup);
      document.getElementById('popupFindBoxBtn').addEventListener('click', function() {
        stopScan();
        const recordAscii = document.getElementById('popupRecord').innerText;
        window.location.href = "findBox.html?tag=" + encodeURIComponent(recordAscii);
      });

      document.getElementById('popupPullSPBtn').addEventListener('click', function() {
        const ascii = document.getElementById('popupRecord').innerText.trim().toUpperCase();
        const info = dbMap.get(ascii);
        const el = document.getElementById('sharepointData');
        el.style.display = "block";
        if (!info) {
          el.innerText = "No DB match found for: " + ascii;
          return;
        }
        el.innerHTML = `
          <div style="text-align:left; font-size:14px;">
            <div><b>LOT:</b> ${escapeHtml(info.lot || "")}</div>
            <div><b>DEPT:</b> ${escapeHtml(info.dept || "")}</div>
            <div><b>ROW:</b> ${escapeHtml(info.row || "")}</div>
            <div><b>DEPT LOT:</b> ${escapeHtml(info.deptLot || "")}</div>
            <div><b>SUPPLIER:</b> ${escapeHtml(info.supplier || "")}</div>
            <div><b>TYPE:</b> ${escapeHtml(info.type || "")}</div>
            <div><b>COLOR:</b> ${escapeHtml(info.color || "")}</div>
            <div><b>FORMAT:</b> ${escapeHtml(info.format || "")}</div>
            <div><b>POUNDS:</b> ${escapeHtml(info.pounds || "")}</div>
            <div><b>PRICE:</b> ${escapeHtml(info.price || "")}</div>
            <div><b>FREIGHT:</b> ${escapeHtml(info.freight || "")}</div>
            <div><b>TOLL:</b> ${escapeHtml(info.toll || "")}</div>
            <div><b>DATE:</b> ${escapeHtml(info.date || "")}</div>
          </div>
        `;
      });

      document.getElementById('popupCopyAsciiBtn').addEventListener('click', async () => {
        const txt = document.getElementById('popupRecord').innerText;
        try { await navigator.clipboard.writeText(txt); showTemporaryMessage("ASCII copied", "green"); }
        catch { showTemporaryMessage("Copy failed", "red"); }
      });

      // Keep "time since last new tag" ticking even when no tags arrive
      setInterval(() => updateTimeWindowOnly(), 1000);
      setInterval(() => renderReaderHealth(), 5000);

      window.addEventListener("beforeunload", function (e) {
        if (isScanning) {
          e.preventDefault();
          e.returnValue = true;
        }
      });
    }

    function safeJson(r){ if(!r.ok) throw new Error(r.status); return r.json(); }

    async function loadDbMap() {
      try {
        const resp = await fetch('/api/db/all', { cache: 'no-store' });
        if (!resp.ok) throw new Error("DB HTTP " + resp.status);
        const data = await resp.json();

        const objs = normalizeDbResponseToObjects(data);
        const nextMap = new Map();

        for (const r of objs) {
          const key = (getAny(r, ["RFIDBOX","RfidBox","rfidbox"]) || "").toString().trim().toUpperCase();
          if (!key) continue;

          nextMap.set(key, {
            lot:      getAny(r, ["LOT","Lot","RFID","Rfid","Tag","TAG","ASCII"]) || "",
            dept:     getAny(r, ["DEPT","Dept","DEPARTMENT","Department"]) || "",
            row:      getAny(r, ["ROW","Row"]) || "",
            deptLot:  getAny(r, ["DEPT LOT","Dept Lot","DEPTLOT","DeptLot"]) || "",
            supplier: getAny(r, ["SUPPLIER","Supplier","CUSTOMER","Customer"]) || "",
            type:     getAny(r, ["TYPE","Type","MATERIAL","Material"]) || "",
            color:    getAny(r, ["COLOR","Color"]) || "",
            format:   getAny(r, ["FORMAT","Format"]) || "",
            pounds:   getAny(r, ["POUNDS","Pounds","WEIGHT","Weight"]) || "",
            price:    getAny(r, ["PRICE","Price"]) || "",
            freight:  getAny(r, ["FREIGHT","Freight"]) || "",
            toll:     getAny(r, ["TOLL","Toll","TOLLING","TOLLING "]) || "",
            date:     getAny(r, ["DATE","Date"]) || ""
          });
        }

        dbMap = nextMap;
        showTemporaryMessage(`DB loaded: ${dbMap.size} rows`, "blue");
      } catch (e) {
        console.warn("DB map load failed:", e);
        showTemporaryMessage("DB load failed (joins/charts limited)", "orange");
        dbMap = new Map();
      }
    }

    function normalizeDbResponseToObjects(data) {
      if (Array.isArray(data)) return data;
      if (data && Array.isArray(data.columns) && Array.isArray(data.rows)) {
        const cols = data.columns.map(c => String(c || "").trim());
        return data.rows.map(arr => {
          const o = {};
          for (let i = 0; i < cols.length; i++) {
            const k = cols[i] || ("COL" + i);
            const v = Array.isArray(arr) ? arr[i] : "";
            o[k] = (v === null || v === undefined) ? "" : v;
          }
          return o;
        });
      }
      return [];
    }

    function getAny(obj, keys) {
      for (const k of keys) {
        if (obj && Object.prototype.hasOwnProperty.call(obj, k)) return obj[k];
      }
      if (obj) {
        const map = new Map(Object.keys(obj).map(x => [x.toLowerCase(), x]));
        for (const k of keys) {
          const hit = map.get(String(k).toLowerCase());
          if (hit) return obj[hit];
        }
      }
      return "";
    }

    function escapeHtml(s) {
      return String(s ?? '')
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#39;');
    }

    function getReaderLabel(tag) {
      if (!tag) return "";
      return tag.reader || tag.readerName || tag.readerIp || "";
    }

    function parseNumberLoose(v) {
      if (v === null || v === undefined) return 0;
      const s = String(v).trim();
      if (!s) return 0;
      const cleaned = s.replace(/[$, ]+/g, '').replace(/[^\d.\-]/g, '');
      const n = parseFloat(cleaned);
      return Number.isFinite(n) ? n : 0;
    }

    function normalizeTimestampMs(ts) {
      if (ts === null || ts === undefined || ts === "") return 0;
      if (ts instanceof Date) return ts.getTime();
      if (typeof ts === "number") return ts > 1e12 ? ts : ts * 1000;

      const str = String(ts).trim();
      if (!str) return 0;

      if (/^[+-]?\d+(\.\d+)?$/.test(str)) {
        const num = Number(str);
        if (Number.isFinite(num)) return num > 1e12 ? num : num * 1000;
      }

      const parsed = new Date(str).getTime();
      return Number.isFinite(parsed) ? parsed : 0;
    }

    function getTagUniqueKey(tag) {
      const candidates = [tag.epcAscii, tag.epcHex, tag.tidHex, tag.tid, tag.epc, tag.id];
      for (const c of candidates) {
        if (c !== undefined && c !== null && c !== "") return String(c);
      }
      return null;
    }

    function hasNonBlank(v) {
      return String(v ?? "").trim().length > 0;
    }

    function startScan() {
      fetch('/api/start').then(safeJson).then(data => {
        showTemporaryMessage(data.message || "Started", "green");
        isScanning = true;
        document.getElementById('scanningStatus').innerText = "üü¢ Scanning...";
        document.getElementById('scanningStatus').style.color = "green";
        if (elapsedTime) startTime = new Date(new Date() - elapsedTime);
        else startTime = new Date();
        startTimer();
      }).catch(() => showTemporaryMessage("Failed to start scan", "red"));
    }
    function pauseScan() {
      fetch('/api/pause').then(safeJson).then(data => {
        showTemporaryMessage(data.message || "Paused", "orange");
        isScanning = false;
        document.getElementById('scanningStatus').innerText = "üü† Paused";
        document.getElementById('scanningStatus').style.color = "orange";
        elapsedTime = new Date() - startTime;
        stopTimer();
      }).catch(() => showTemporaryMessage("Failed to pause scan", "red"));
    }
    function stopScan() {
      fetch('/api/stop').then(safeJson).then(data => {
        showTemporaryMessage(data.message || "Stopped", "red");
        isScanning = false;
        document.getElementById('scanningStatus').innerText = "üî¥ Not Scanning";
        document.getElementById('scanningStatus').style.color = "red";
        stopTimer();
        elapsedTime = 0;
      }).catch(() => showTemporaryMessage("Failed to stop scan", "red"));
    }
    function clearData() {
      if (!confirm("Are you sure you want to CLEAR all data?")) return;
      fetch('/api/clear').then(safeJson).then(data => {
        showTemporaryMessage(data.message || "Cleared", "blue");
        allTags = [];
        lastNewTagAt = 0;
        renderTags([]);
        resetTimerDisplay();
        updateStats(true);
      }).catch(() => showTemporaryMessage("Failed to clear data", "red"));
    }
    function exportData() {
      // Joined XLSX export endpoint (server-side join)
      window.location = '/api/exportJoined';
    }

    function exportFiltered() {
      const rows = lastFiltered || [];
      if (!rows.length) { showTemporaryMessage("No rows to export", "orange"); return; }

      const header = [
        "First Seen","TID (Hex)","EPC (Hex)","ASCII","RSSI","SeenCount",
        "LOT","DEPT","ROW","DEPT LOT","SUPPLIER","TYPE","COLOR","FORMAT","POUNDS","PRICE","FREIGHT","TOLL","DATE"
      ];
      const lines = [header.join(",")];

      for (const t of rows) {
        const asciiKey = (t.epcAscii || "").toString().trim().toUpperCase();
        const db = dbMap.get(asciiKey) || {};

        const cols = [
          t._ts ? new Date(t._ts).toISOString() : "",
          t.tidHex || "",
          t.epcHex || "",
          (t.epcAscii || "").replace(/"/g,'""'),
          (t.rssi ?? "").toString(),
          (t.seenCount ?? "").toString(),
          (db.lot || "").toString(),
          (db.dept || "").toString(),
          (db.row || "").toString(),
          (db.deptLot || "").toString(),
          (db.supplier || "").toString(),
          (db.type || "").toString(),
          (db.color || "").toString(),
          (db.format || "").toString(),
          (db.pounds || "").toString(),
          (db.price || "").toString(),
          (db.freight || "").toString(),
          (db.toll || "").toString(),
          (db.date || "").toString()
        ];

        lines.push(cols.map(v => {
          const s = String(v ?? "");
          return /[",\n]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s;
        }).join(","));
      }

      const blob = new Blob([lines.join("\n")], {type:"text/csv;charset=utf-8"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'filtered_tags_with_db.csv';
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    function startTimer() {
      if (timerInterval) clearInterval(timerInterval);
      timerInterval = setInterval(updateTimer, 1000);
    }
    function stopTimer() {
      if (timerInterval) {
        clearInterval(timerInterval);
        timerInterval = null;
      }
    }
    function resetTimerDisplay() {
      document.getElementById('timer').innerText = '00:00:00';
      startTime = null;
      elapsedTime = 0;
      stopTimer();
    }
    function updateTimer() {
      if (!startTime) return;
      const now = new Date();
      const diff = Math.floor((now - startTime) / 1000);
      const hrs = String(Math.floor(diff / 3600)).padStart(2, '0');
      const mins = String(Math.floor((diff % 3600) / 60)).padStart(2, '0');
      const secs = String(diff % 60).padStart(2, '0');
      document.getElementById('timer').innerText = `${hrs}:${mins}:${secs}`;
    }

    function refreshTags() {
      fetch('/api/tags')
        .then(r => r.ok ? r.json() : Promise.reject(r.status))
        .then(tags => {
          tags.forEach(t => {
            t._ascii = (t.epcAscii || "").toLowerCase();
            t._ts = Date.parse(t.firstSeen || 0) || 0;
            t._readerKey = getReaderLabel(t);
          });
          allTags = tags;
          applyFilter();
        })
        .catch(err => console.error("Error fetching tags:", err));
    }

    function matchesLotType(ascii, ltype) {
      if (!ltype) return true;
      if (!ascii) return ltype === 'Other';
      if (ltype === 'Other') {
        return !(ascii.startsWith('PL') || ascii.startsWith('FF') || ascii.startsWith('BL') || ascii.startsWith('GL'));
      }
      return ascii.startsWith(ltype);
    }

    function applyFilter() {
      const q = document.getElementById('searchInput').value.trim().toLowerCase();
      let filtered = allTags;

      if (q) filtered = filtered.filter(t => (t._ascii || "").includes(q));
      if (lotTypeFilter) filtered = filtered.filter(t => matchesLotType(t.epcAscii || "", lotTypeFilter));

      if (currentSort === 'firstSeen') {
        filtered = [...filtered].sort((a, b) => b._ts - a._ts);
      } else if (currentSort === 'epcAscii') {
        filtered = [...filtered].sort((a, b) => (a._ascii || "").localeCompare(b._ascii || ""));
      }

      lastFiltered = filtered;
      renderTags(filtered);
      updateStats(false);
      syncStateToUrl();
    }

    function renderTags(tags) {
      const tbody = document.getElementById('tagsBody');
      tbody.innerHTML = "";

      const totalPages = Math.ceil(tags.length / pageSize) || 1;
      if(currentPage > totalPages) currentPage = totalPages;

      const start = (currentPage - 1) * pageSize;
      const pageTags = tags.slice(start, start + pageSize);

      const frag = document.createDocumentFragment();
      for (const t of pageTags) {
        const asciiKey = (t.epcAscii || "").toString().trim().toUpperCase();
        const db = dbMap.get(asciiKey) || {};

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${t._ts ? new Date(t._ts).toLocaleString() : ""}</td>
          <td>${escapeHtml(t.tidHex || "")}</td>
          <td>${escapeHtml(t.epcHex || "")}</td>
          <td>${escapeHtml(t.epcAscii || "")}</td>
          <td>${escapeHtml(t.rssi ?? "")}</td>
          <td>${escapeHtml(t.seenCount ?? "")}</td>
          <td class="truncate" title="${escapeHtml(db.lot || "")}">${escapeHtml(db.lot || "")}</td>
          <td class="truncate" title="${escapeHtml(db.dept || "")}">${escapeHtml(db.dept || "")}</td>
          <td class="truncate" title="${escapeHtml(db.row || "")}">${escapeHtml(db.row || "")}</td>
          <td class="truncate" title="${escapeHtml(db.deptLot || "")}">${escapeHtml(db.deptLot || "")}</td>
          <td class="truncate" title="${escapeHtml(db.supplier || "")}">${escapeHtml(db.supplier || "")}</td>
          <td class="truncate" title="${escapeHtml(db.type || "")}">${escapeHtml(db.type || "")}</td>
          <td class="truncate" title="${escapeHtml(db.color || "")}">${escapeHtml(db.color || "")}</td>
          <td class="truncate" title="${escapeHtml(db.format || "")}">${escapeHtml(db.format || "")}</td>
          <td>${escapeHtml(db.pounds || "")}</td>
          <td>${escapeHtml(db.price || "")}</td>
          <td>${escapeHtml(db.freight || "")}</td>
          <td>${escapeHtml(db.toll || "")}</td>
          <td class="truncate" title="${escapeHtml(db.date || "")}">${escapeHtml(db.date || "")}</td>
        `;
        tr.addEventListener('click', (e) => { e.stopPropagation(); openRecordOptionsPopup(t); });
        frag.appendChild(tr);
      }
      tbody.appendChild(frag);

      document.getElementById('count').innerText = tags.length;
      renderPagination(totalPages, currentPage);
    }

    function changePage(newPage) {
      if(newPage < 1) return;
      const q = document.getElementById('searchInput').value.trim().toLowerCase();
      let filtered = allTags;
      if (q) filtered = filtered.filter(t => (t._ascii || "").includes(q));
      if (lotTypeFilter) filtered = filtered.filter(t => matchesLotType(t.epcAscii || "", lotTypeFilter));
      const totalPages = Math.ceil(filtered.length / pageSize) || 1;
      if(newPage > totalPages) return;
      currentPage = newPage;
      applyFilter();
    }

    function sortTags(field) {
      currentSort = field;
      applyFilter();
    }

    function showTemporaryMessage(msg, color="blue") {
      const el = document.getElementById('statusMessage');
      el.innerText = msg;
      el.style.color = color;
      el.style.visibility = "visible";
      setTimeout(() => { el.style.visibility = "hidden"; }, 3000);
    }

    function renderPagination(totalPages, currentPage) {
      const c = document.getElementById('paginationControls');
      c.innerHTML = "";

      const mkBtn = (txt, fn, disabled=false) => {
        const b = document.createElement('button');
        b.textContent = txt;
        b.disabled = disabled;
        if (!disabled) b.addEventListener('click', fn);
        return b;
      };

      c.appendChild(mkBtn("First", () => changePage(1), currentPage === 1));
      c.appendChild(mkBtn("Previous", () => changePage(currentPage - 1), currentPage === 1));

      const label = document.createElement('span');
      label.style.margin = '0 8px';
      label.textContent = `Page ${currentPage} of ${totalPages}`;
      c.appendChild(label);

      c.appendChild(mkBtn("Next", () => changePage(currentPage + 1), currentPage === totalPages));
      c.appendChild(mkBtn("Last", () => changePage(totalPages), currentPage === totalPages));
    }

    function renderReaderCounts() {
      const tbody = document.getElementById('readerCountsBody');
      if (!tbody) return;
      tbody.innerHTML = "";

      const cutoff = Date.now() - 60000;
      const counts = new Map();

      for (const tag of allTags) {
        const readerName = getReaderLabel(tag);
        if (!readerName) continue;
        const entry = counts.get(readerName) || { reader: readerName, unique: 0, last60: 0 };
        entry.unique += 1;
        if ((tag._ts || 0) >= cutoff) entry.last60 += 1;
        counts.set(readerName, entry);
      }

      const rows = Array.from(counts.values()).sort((a, b) => a.reader.localeCompare(b.reader));
      if (!rows.length) {
        const tr = document.createElement('tr');
        const td = document.createElement('td');
        td.colSpan = 3;
        td.textContent = "No reader attribution";
        tr.appendChild(td);
        tbody.appendChild(tr);
        return;
      }

      for (const r of rows) {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${escapeHtml(r.reader)}</td><td>${r.unique}</td><td>${r.last60}</td>`;
        tbody.appendChild(tr);
      }
    }

    function updateStats(force) {
      const now = Date.now();
      if (!force && (now - lastStatsAt) < STATS_MIN_INTERVAL_MS) return;
      lastStatsAt = now;

      let pl = 0, ff = 0, bl = 0, gl = 0, other = 0;
      let len8 = 0, len12 = 0, len16 = 0, lenOther = 0;

      const typeCounts = new Map();
      const colorCounts = new Map();

      let totalPounds = 0;
      let totalValue = 0;

      let dbMatched = 0;
      let dbUnmatched = 0;

      let hasPounds = 0;
      let noPounds  = 0;
      let hasPrice  = 0;
      let noPrice   = 0;

      const nowMs = Date.now();
      const since60 = nowMs - 60000;
      const cutoff10s = nowMs - 10_000;
      const uniqueLast10 = new Set();
      let tagsLast60 = 0;

      for (const tag of allTags) {
        const ascii = tag.epcAscii || "";

        if(ascii.startsWith("PL")) pl++;
        else if(ascii.startsWith("FF")) ff++;
        else if(ascii.startsWith("BL")) bl++;
        else if(ascii.startsWith("GL")) gl++;
        else other++;

        const len = ascii.length;
        if(len === 8) len8++;
        else if(len === 12) len12++;
        else if(len === 16) len16++;
        else lenOther++;

        const tsSource = (tag.lastSeen !== undefined && tag.lastSeen !== null && tag.lastSeen !== "") ? tag.lastSeen : (tag.firstSeen ?? tag._ts);
        const normalizedTs = normalizeTimestampMs(tsSource || tag._ts);
        const keyForUniq = getTagUniqueKey(tag);
        if (normalizedTs >= cutoff10s && keyForUniq) uniqueLast10.add(keyForUniq);

        if ((tag._ts || 0) >= since60) tagsLast60++;

        const asciiKey = ascii.toString().trim().toUpperCase();
        const db = dbMap.get(asciiKey);

        if (db) dbMatched++; else dbUnmatched++;

        const t = (db && db.type ? String(db.type).trim() : "") || "Unknown";
        const c = (db && db.color ? String(db.color).trim() : "") || "Unknown";
        typeCounts.set(t, (typeCounts.get(t) || 0) + 1);
        colorCounts.set(c, (colorCounts.get(c) || 0) + 1);

        // Completeness: treat DB-missing as missing
        const poundsPresent = db && hasNonBlank(db.pounds);
        const pricePresent  = db && hasNonBlank(db.price);

        if (poundsPresent) hasPounds++; else noPounds++;
        if (pricePresent)  hasPrice++;  else noPrice++;

        if (db) {
          const pds = parseNumberLoose(db.pounds);
          const prc = parseNumberLoose(db.price);
          totalPounds += pds;
          totalValue += (pds * prc);
        }
      }

      const totalLot = pl + ff + bl + gl + other;
      const totalLen = len8 + len12 + len16 + lenOther;
      const tagsLast10Unique = uniqueLast10.size;

      document.getElementById('plCount').innerText = pl + " (" + (totalLot ? (pl/totalLot*100).toFixed(1) : 0) + "%)";
      document.getElementById('ffCount').innerText = ff + " (" + (totalLot ? (ff/totalLot*100).toFixed(1) : 0) + "%)";
      document.getElementById('blCount').innerText = bl + " (" + (totalLot ? (bl/totalLot*100).toFixed(1) : 0) + "%)";
      document.getElementById('glCount').innerText = gl + " (" + (totalLot ? (gl/totalLot*100).toFixed(1) : 0) + "%)";
      document.getElementById('otherCount').innerText = other + " (" + (totalLot ? (other/totalLot*100).toFixed(1) : 0) + "%)";

      document.getElementById('len8Count').innerText = len8 + " (" + (totalLen ? (len8/totalLen*100).toFixed(1) : 0) + "%)";
      document.getElementById('len12Count').innerText = len12 + " (" + (totalLen ? (len12/totalLen*100).toFixed(1) : 0) + "%)";
      document.getElementById('len16Count').innerText = len16 + " (" + (totalLen ? (len16/totalLen*100).toFixed(1) : 0) + "%)";
      document.getElementById('lenOtherCount').innerText = lenOther + " (" + (totalLen ? (lenOther/totalLen*100).toFixed(1) : 0) + "%)";

      document.getElementById('lotTypeTotal').innerText = totalLot;
      document.getElementById('lenTotal').innerText   = totalLen;

      document.getElementById('totalPounds').innerText = totalPounds.toLocaleString(undefined, { maximumFractionDigits: 2 });
      document.getElementById('totalValue').innerText  = totalValue.toLocaleString(undefined, { style: "currency", currency: "USD" });

      const totalScan = dbMatched + dbUnmatched;
      const matchPct = totalScan ? ((dbMatched / totalScan) * 100).toFixed(1) : "0.0";
      document.getElementById('dbMatchRate').innerText = `${dbMatched} / ${totalScan} (${matchPct}%)`;

      document.getElementById('hasPounds').innerText = hasPounds.toLocaleString();
      document.getElementById('noPounds').innerText  = noPounds.toLocaleString();
      document.getElementById('hasPrice').innerText  = hasPrice.toLocaleString();
      document.getElementById('noPrice').innerText   = noPrice.toLocaleString();

      document.getElementById('tagsLast10Unique').innerText = tagsLast10Unique.toLocaleString();
      document.getElementById('tagsLast60').innerText = tagsLast60.toLocaleString();
      document.getElementById('newPerMin').innerText  = tagsLast60.toLocaleString();
      // sinceLastNew is updated in updateTimeWindowOnly()

      updateLotTypeChart([pl, ff, bl, gl, other]);

      const typeTop = topNWithUnknownFirst(typeCounts, 10);
      updateGenericPieChart("typeChart", typeTop.labels, typeTop.values, (c) => typeChart = c, () => typeChart);

      const colorTop = topNWithUnknownFirst(colorCounts, 10);
      updateGenericPieChart("colorChart", colorTop.labels, colorTop.values, (c) => colorChart = c, () => colorChart);

      updateTimeWindowOnly();
      renderReaderCounts();
    }

    function updateTimeWindowOnly() {
      const el = document.getElementById('sinceLastNew');
      if (!el) return;
      if (!lastNewTagAt) {
        el.innerText = "‚Äî";
        return;
      }
      const diffSec = Math.floor((Date.now() - lastNewTagAt) / 1000);
      if (diffSec < 60) el.innerText = `${diffSec}s`;
      else if (diffSec < 3600) el.innerText = `${Math.floor(diffSec/60)}m ${diffSec%60}s`;
      else el.innerText = `${Math.floor(diffSec/3600)}h ${Math.floor((diffSec%3600)/60)}m`;
    }

    function topNWithUnknownFirst(countMap, n) {
      const entries = Array.from(countMap.entries());
      entries.sort((a, b) => b[1] - a[1]);

      const unknownIdx = entries.findIndex(e => String(e[0]).toLowerCase() === "unknown");
      if (unknownIdx > 0) {
        const u = entries.splice(unknownIdx, 1)[0];
        entries.unshift(u);
      }

      const top = entries.slice(0, n);
      const rest = entries.slice(n);
      const restTotal = rest.reduce((s, e) => s + e[1], 0);

      const labels = top.map(e => e[0]);
      const values = top.map(e => e[1]);

      if (restTotal > 0) {
        labels.push("Other");
        values.push(restTotal);
      }

      return { labels, values };
    }

    function updateLotTypeChart(dataArray) {
      const canvas = document.getElementById('lotTypeChart');
      if (!canvas) return;
      const ctx = canvas.getContext('2d');
      const total = dataArray.reduce((sum, val) => sum + val, 0);

      if (lotChart) {
        lotChart.data.datasets[0].data = dataArray;
        lotChart.update();
        return;
      }

      lotChart = new Chart(ctx, {
        type: 'pie',
        data: {
          labels: ['PL', 'FF', 'BL', 'GL', 'Other'],
          datasets: [{ data: dataArray }]
        },
        options: {
          responsive: false,
          maintainAspectRatio: false,
          animation: { duration: 200 },
          plugins: {
            legend: { position: 'bottom', labels: { font: { size: 14 } } },
            datalabels: {
              formatter: (value, ctx) => {
                const data = ctx.chart.data.datasets[0].data || [];
                const total = data.reduce((a,b)=>a + (Number(b)||0), 0);
                const pct = total ? ((Number(value)||0) / total) * 100 : 0;
                return pct >= 2 ? pct.toFixed(1) + '%' : '';
              },
              anchor: 'center',
              align: 'center',
              clamp: true
            }
          },
          onClick: (evt) => {
            const points = lotChart.getElementsAtEventForMode(evt, 'nearest', { intersect: true }, true);
            if (!points.length) return;
            const idx = points[0].index;
            const label = lotChart.data.labels[idx];
            lotTypeFilter = (lotTypeFilter === label) ? null : label;
            currentPage = 1;
            applyFilter();
            showTemporaryMessage(lotTypeFilter ? `Filtered by ${lotTypeFilter}` : "Cleared Lot Type filter", "blue");
          }
        }
      });
    }

    function updateGenericPieChart(canvasId, labels, values, setChart, getChart) {
      const canvas = document.getElementById(canvasId);
      if (!canvas) return;
      const ctx = canvas.getContext('2d');

      const existing = getChart();
      if (existing) {
        existing.data.labels = labels;
        existing.data.datasets[0].data = values;
        existing.update();
        return;
      }

      const chart = new Chart(ctx, {
        type: 'pie',
        data: {
          labels: labels,
          datasets: [{ data: values }]
        },
        options: {
          responsive: false,
          maintainAspectRatio: false,
          animation: { duration: 200 },
          plugins: {
            legend: { position: 'bottom', labels: { font: { size: 14 } } },
            datalabels: {
              formatter: (value, ctx) => {
                const data = ctx.chart.data.datasets[0].data || [];
                const total = data.reduce((a,b)=>a + (Number(b)||0), 0);
                const pct = total ? ((Number(value)||0) / total) * 100 : 0;
                return pct >= 2 ? pct.toFixed(1) + '%' : '';
              },
              anchor: 'center',
              align: 'center',
              clamp: true
            }
          }
        }
      });

      setChart(chart);
    }

    function openRecordOptionsPopup(record) {
      document.getElementById('popupRecord').innerText = record.epcAscii || "";
      document.getElementById('sharepointData').style.display = "none";
      document.getElementById('sharepointData').innerText = "";
      document.getElementById('recordOptionsPopup').style.display = "block";
    }
    function closeRecordOptionsPopup() {
      document.getElementById('recordOptionsPopup').style.display = "none";
    }
    function closeFindBoxModal() {
      document.getElementById('findBoxModal').style.display = "none";
    }
    function findBox() {
      const searchText = document.getElementById('findBoxInput').value.trim().toLowerCase();
      if (!searchText) {
        alert("Please enter an ASCII tag value.");
        return;
      }
      const matches = allTags.filter(t => (t._ascii || "").includes(searchText));
      if (matches.length === 0) {
        alert("No matching tag found.");
        updateSignalIndicator(-100);
      } else {
        const bestMatch = matches.reduce((prev, curr) => (prev.rssi > curr.rssi ? prev : curr));
        updateSignalIndicator(bestMatch.rssi);
      }
    }
    function scaleForRSSI(rssi) {
      rssi = Math.max(-90, Math.min(rssi, -50));
      return (-rssi * 0.025 + 3.25);
    }
    function updateSignalIndicator(rssi) {
      const indicator = document.getElementById('signalIndicator');
      if(rssi === 0) {
        indicator.style.transform = "scale(1)";
        indicator.style.backgroundColor = "rgba(37,64,143,0.5)";
      } else {
        const scaleVal = scaleForRSSI(rssi);
        indicator.style.transform = "scale(" + scaleVal + ")";
        let intensity = Math.round(50 + ((-rssi - 50) / 40) * 205);
        indicator.style.backgroundColor = "rgba(37,64,143," + (intensity/255).toFixed(2) + ")";
      }
    }

    function syncStateToUrl() {
      const params = new URLSearchParams(window.location.search);
      const q = document.getElementById('searchInput').value.trim();
      if (q) params.set('q', q); else params.delete('q');
      params.set('sort', currentSort);
      params.set('page', String(currentPage));
      if (lotTypeFilter) params.set('ltype', lotTypeFilter); else params.delete('ltype');
      history.replaceState(null, '', `${window.location.pathname}?${params.toString()}`);
    }

    function restoreStateFromUrl() {
      const params = new URLSearchParams(window.location.search);
      const q = params.get('q') || '';
      const sort = params.get('sort') || 'firstSeen';
      const page = parseInt(params.get('page') || '1', 10);
      const ltype = params.get('ltype');

      document.getElementById('searchInput').value = q;
      currentSort = (sort === 'epcAscii') ? 'epcAscii' : 'firstSeen';
      currentPage = Number.isFinite(page) && page > 0 ? page : 1;
      lotTypeFilter = (ltype === 'PL' || ltype === 'FF' || ltype === 'BL' || ltype === 'GL' || ltype === 'Other') ? ltype : null;
    }

    function showTemporaryMessage(msg, color="blue") {
      const el = document.getElementById('statusMessage');
      el.innerText = msg;
      el.style.color = color;
      el.style.visibility = "visible";
      setTimeout(() => { el.style.visibility = "hidden"; }, 3000);
    }
  </script>
</body>
</html>
